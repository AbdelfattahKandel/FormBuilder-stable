<!-- Show ArrayRender if fields exist, otherwise show configure button -->
@if ((field().arrayFields?.length || 0) > 0) {
  <div class="space-y-2">
    <app-array-render [arrayField]="field()" [parentForm]="parentForm()" />
    <button
      type="button"
      (click)="openEditor()"
      class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors text-sm"
    >
      <i class="pi pi-cog mr-2"></i>
      Edit Array Configuration ({{ field().arrayFields?.length || 0 }} fields)
    </button>
  </div>
} @else {
  <button
    type="button"
    (click)="openEditor()"
    class="w-full px-3 py-2 bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg hover:bg-blue-100 transition-colors"
  >
    <div class="flex items-center justify-center gap-2 text-blue-600">
      <i class="pi pi-plus-circle"></i>
      <span class="font-medium">Configure Array Fields ({{ field().arrayFields?.length || 0 }} fields)</span>
    </div>
  </button>
}

<!-- Array Editor Dialog -->
<p-dialog
  header="Configure Array Fields"
  [(visible)]="showEditor"
  [modal]="true"
  [style]="{ width: '90vw', height: '90vh' }"
  [maximizable]="true"
>
  <div class="flex gap-4 h-full">
    <!-- Left: Palette -->
    <div class="w-64 flex-shrink-0 border-r border-gray-200 pr-4 overflow-y-auto">
      <h3 class="text-sm font-semibold text-gray-900 mb-3">Available Fields</h3>
      <div cdkDropList [cdkDropListData]="tools" id="array-palette-list" [cdkDropListConnectedTo]="['array-drop-zone']" class="space-y-2">
        @for (tool of tools; track tool.type) {
          <div
            cdkDrag
            [cdkDragData]="tool"
            class="flex items-center gap-2 p-2 bg-white border border-gray-200 rounded-lg cursor-move hover:border-blue-400 hover:shadow-md transition-all"
          >
            <i [class]="'pi ' + tool.icon + ' text-blue-600'"></i>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-gray-900 truncate">{{ tool.label }}</p>
            </div>
            <i class="pi pi-arrows-alt text-gray-400 text-xs"></i>
          </div>
        }
      </div>
    </div>

    <!-- Right: Drop Zone -->
    <div class="flex-1 flex flex-col min-w-0">
      <div class="mb-3">
        <p class="text-sm text-gray-600">
          Drag fields from the left to define the structure of each array item.
        </p>
      </div>

      <div
        cdkDropList
        [cdkDropListData]="arrayFields()"
        (cdkDropListDropped)="onDrop($event)"
        [cdkDropListConnectedTo]="['array-palette-list']"
        id="array-drop-zone"
        class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50 overflow-y-auto"
      >
      @if (arrayFields().length === 0) {
        <div class="flex flex-col items-center justify-center h-full text-gray-400">
          <i class="pi pi-inbox text-6xl mb-4"></i>
          <p class="text-lg font-medium">No fields yet</p>
          <p class="text-sm">Drag fields from the palette to add them to the array</p>
        </div>
      } @else {
        <div class="space-y-3">
          @for (field of arrayFields(); track trackByFieldId($index, field)) {
            <div
              cdkDrag
              class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-400 transition-all"
            >
              <div class="flex items-start gap-3">
                <!-- Drag Handle -->
                <div class="flex-shrink-0 mt-2">
                  <i class="pi pi-bars text-gray-400 cursor-move"></i>
                </div>

                <!-- Field Preview -->
                <div class="flex-1 min-w-0">
                  <div class="space-y-1">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-semibold text-gray-700">{{ field.label }}</span>
                      @if (field.required) {
                        <span class="text-red-500 text-xs">*</span>
                      }
                    </div>
                    <div class="text-xs text-gray-500">
                      Type: <span class="font-mono">{{ field.type }}</span> | 
                      Key: <span class="font-mono">{{ field.formControlName }}</span>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-1">
                  <button
                    type="button"
                    (click)="onEditField(field)"
                    class="flex-shrink-0 p-2 text-blue-500 hover:bg-blue-50 rounded transition-colors"
                    title="Edit field"
                  >
                    <i class="pi pi-pencil text-xs"></i>
                  </button>
                  <button
                    type="button"
                    (click)="onRemoveField(field.id)"
                    class="flex-shrink-0 p-2 text-red-500 hover:bg-red-50 rounded transition-colors"
                    title="Remove field"
                  >
                    <i class="pi pi-trash text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <span class="text-sm text-gray-500">{{ arrayFields().length }} field(s) configured</span>
      <div class="flex gap-2">
        <p-button label="Cancel" icon="pi pi-times" (onClick)="onCancel()" styleClass="p-button-text"></p-button>
        <p-button label="Save" icon="pi pi-check" (onClick)="onSave()" styleClass="p-button-success"></p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Field Editor Dialog -->
<p-dialog
  header="Edit Field"
  [(visible)]="showFieldEditor"
  [modal]="true"
  [style]="{ width: '600px' }"
>
  @if (editingField()) {
    <app-field-editor-dialog
      [field]="editingField()!"
      (fieldSaved)="onFieldEditorSaved($event)"
      (cancelled)="onFieldEditorCancelled()"
    ></app-field-editor-dialog>
  }
</p-dialog>
